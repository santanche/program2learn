#!/bin/bash
set -e

# --- Part 1: Install guile-simple-zmq locally ---
# This part was working correctly and installs the dependency to your home directory.
git clone https://github.com/jerry40/guile-simple-zmq.git
cd guile-simple-zmq
autoreconf -vif
./configure --prefix=$HOME/.local
make
make install
cd ..


# --- Part 2: Manually Install the Jupyter Guile Kernel ---
# This replicates the Dockerfile logic by cloning the kernel into the correct directory.
KERNEL_DIR="$HOME/.local/share/jupyter/kernels/guile"
mkdir -p "$KERNEL_DIR"
git clone https://github.com/jerry40/guile-kernel.git "$KERNEL_DIR"


# --- Part 3: Configure the Environment ---
# This startup script is still needed to tell Guile where to find guile-simple-zmq.
STARTUP_FILE=.binder/start
mkdir -p .binder
echo '#!/bin/bash' > $STARTUP_FILE
echo 'export GUILE_LOAD_PATH="$HOME/.local/share/guile/site/3.0${GUILE_LOAD_PATH:+:}$GUILE_LOAD_PATH"' >> $STARTUP_FILE
echo 'export LD_LIBRARY_PATH="$HOME/.local/lib${LD_LIBRARY_PATH:+:}$LD_LIBRARY_PATH"' >> $STARTUP_FILE
