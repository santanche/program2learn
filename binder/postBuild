#!/bin/bash
set -e

# --- Part 1: Install guile-simple-zmq locally ---
# This part is correct and unchanged.
git clone https://github.com/jerry40/guile-simple-zmq.git
cd guile-simple-zmq
autoreconf -vif
./configure --prefix=$HOME/.local
make
make install
cd ..


# --- Part 2: Manually Install the Jupyter Guile Kernel ---
# This section is now corrected to copy the files to the right place.
KERNEL_DIR="$HOME/.local/share/jupyter/kernels/guile"
mkdir -p "$KERNEL_DIR"

# Clone the kernel into a temporary directory
git clone https://github.com/jerry40/guile-kernel.git /tmp/guile-kernel

# Copy the essential kernel files (kernel.json and the scheme script)
# from the 'src' sub-folder into the final kernel directory.
cp /tmp/guile-kernel/src/kernel.json "$KERNEL_DIR/"
cp /tmp/guile-kernel/src/guile-jupyter-kernel.scm "$KERNEL_DIR/"

# Clean up the temporary clone
rm -rf /tmp/guile-kernel


# --- Part 3: Configure the Environment ---
# This part is correct and unchanged.
STARTUP_FILE=.binder/start
mkdir -p .binder
echo '#!/bin/bash' > $STARTUP_FILE
echo 'export GUILE_LOAD_PATH="$HOME/.local/share/guile/site/3.0${GUILE_LOAD_PATH:+:}$GUILE_LOAD_PATH"' >> $STARTUP_FILE
echo 'export LD_LIBRARY_PATH="$HOME/.local/lib${LD_LIBRARY_PATH:+:}$LD_LIBRARY_PATH"' >> $STARTUP_FILE