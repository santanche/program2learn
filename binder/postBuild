#!/bin/bash
# Exit script if any command fails
set -e

echo "--- üöÄ Starting Guile Kernel setup for Binder ---"

# Define a local installation directory since we don't have sudo
INSTALL_PREFIX="$HOME/.local"

# **Ensure the necessary environment variables are set for the build process**
# **This line is the FIX: It explicitly adds the system's pkg-config path.**
export PKG_CONFIG_PATH="$INSTALL_PREFIX/lib/pkgconfig:/usr/lib/x86_64-linux-gnu/pkgconfig"
export GUILE_LOAD_PATH="$INSTALL_PREFIX/share/guile/site/3.0${GUILE_LOAD_PATH:+:}$GUILE_LOAD_PATH"

# --- Install guile-json ---
echo "--- üì¶ Installing guile-json ---"
wget https://openbsd.c3sl.ufpr.br/savannah-nongnu/guile-json/guile-json-4.7.1.tar.gz
tar -xzf guile-json-4.7.1.tar.gz
cd guile-json-4.7.1
./configure --prefix="$INSTALL_PREFIX"
make
make install
cd ..

# --- Install guile-simple-zmq ---
echo "--- üì¶ Installing guile-simple-zmq ---"
git clone https://github.com/jerry40/guile-simple-zmq.git
cd guile-simple-zmq
autoreconf --verbose --install --force
./configure --prefix="$INSTALL_PREFIX"
make
make install
cd ..

# --- Configure the Jupyter Kernel ---
echo "--- ‚öôÔ∏è  Configuring Jupyter kernel ---"
KERNEL_DIR="$HOME/.local/share/jupyter/kernels/guile"
mkdir -p "$KERNEL_DIR"

# Copy the kernel's scheme script into the kernel directory
cp src/guile-jupyter-kernel.scm "$KERNEL_DIR/"

# Create the kernel.json file, dynamically inserting the correct path.
# The -L flag explicitly tells guile where to find the libraries we just installed.
cat <<EOF > "$KERNEL_DIR/kernel.json"
{
    "argv": [
        "guile",
        "-L", "$INSTALL_PREFIX/share/guile/site/3.0",
        "-s", "$KERNEL_DIR/guile-jupyter-kernel.scm",
        "--",
        "{connection_file}"
    ],
    "display_name": "Guile",
    "language": "scheme"
}
EOF

echo "--- ‚ú® Guile Kernel setup complete! ---"